<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>今日身份验证码</title>
  <style>
    :root { color-scheme: light dark; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0; padding: 24px; display: grid; place-items: center; min-height: 100dvh;
      background: canvas; color: canvastext;
    }
    .card {
      width: min(720px, 92vw);
      border: 1px solid color-mix(in oklab, canvastext 20%, transparent);
      border-radius: 16px; padding: 24px 20px; box-shadow: 0 8px 28px rgba(0,0,0,0.08);
      background: color-mix(in oklab, canvas 95%, white 5%);
    }
    h1 { margin: 0 0 8px; font-size: 20px; font-weight: 700; letter-spacing: 0.2px; }
    .sub { opacity: 0.7; margin-bottom: 18px; font-size: 13px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin: 8px 0 18px; }
    input[type="password"], input[type="text"] {
      flex: 1 1 260px; padding: 10px 12px; border-radius: 10px; border: 1px solid #bbb5;
      background: canvas; color: canvastext; outline: none; font-size: 14px;
    }
    button {
      padding: 10px 14px; border-radius: 10px; border: 1px solid #bbb5;
      background: color-mix(in oklab, canvas 90%, canvastext 5%); color: canvastext;
      cursor: pointer; font-weight: 600;
    }
    .code {
      font-variant-numeric: tabular-nums; letter-spacing: 2px;
      font-size: clamp(36px, 9vw, 72px); font-weight: 800; text-align: center;
      padding: 18px 0; user-select: all;
    }
    .muted { opacity: 0.65; font-size: 12px; }
    .ok { color: #0a7a2f; font-weight: 600; }
    .warn { color: #9a5a00; font-weight: 600; }
    .grid { display: grid; gap: 8px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>今日身份验证码</h1>
    <div class="sub">规则：6 位字符（3 数字 + 3 字母），基于中国标准时间（UTC+8）当日 + 共享口令，双方一致。</div>

    <div class="grid">
      <label class="muted">共享口令（仅本机保存，不会上传）</label>
      <div class="row">
        <input id="secret" type="password" inputmode="text" autocomplete="off" placeholder="输入你们约定的口令" />
        <button id="toggle">显示</button>
        <button id="save">保存</button>
        <button id="clear">更换口令</button>
      </div>

      <div class="muted">日期基准：<span id="dateStr"></span>（UTC+8）</div>
      <div id="status" class="muted"></div>

      <div class="code" id="code">———</div>

      <div class="muted">
        提示：每天 00:00（UTC+8）自动切换。若两端不一致，请确认口令完全相同、日期与时区一致。
      </div>
    </div>
  </div>

  <script>
    // Convert current time to UTC+8 "YYYY-MM-DD"
    function dateInUTC8String(d = new Date()) {
      const utc = d.getTime() + d.getTimezoneOffset() * 60000;
      const utc8 = new Date(utc + 8 * 3600000);
      const y = utc8.getUTCFullYear();
      const m = String(utc8.getUTCMonth() + 1).padStart(2, '0');
      const day = String(utc8.getUTCDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }

    // Stable shuffle using a seeded generator from bytes
    function seededShuffle(arr, bytes) {
      // xorshift32 seeded from first 4 bytes
      let seed = (bytes[0] << 24) ^ (bytes[1] << 16) ^ (bytes[2] << 8) ^ (bytes[3] << 0);
      if (seed === 0) seed = 0x9e3779b9;
      function rnd() {
        // xorshift32
        let x = seed;
        x ^= x << 13; x ^= x >>> 17; x ^= x << 5;
        seed = x | 0;
        // convert to [0,1)
        return ((seed >>> 0) / 4294967296);
      }
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(rnd() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // Derive daily 6-char code: 3 digits + 3 letters (A-Z), order shuffled deterministically
    async function deriveCode(secret, dateStr) {
      const enc = new TextEncoder();
      const material = enc.encode(`${secret}::${dateStr}::UTC+8`);
      const hashBuf = await crypto.subtle.digest('SHA-256', material);
      const bytes = new Uint8Array(hashBuf);

      // Pick 3 digits and 3 letters from the hash bytes deterministically
      const digits = [];
      const letters = [];
      let i = 0, j = 16;
      while (digits.length < 3 && i < bytes.length) {
        digits.push(String(bytes[i] % 10));
        i++;
      }
      while (letters.length < 3 && j < bytes.length) {
        const v = bytes[j] % 26;
        letters.push(String.fromCharCode(65 + v)); // 'A'..'Z'
        j++;
      }

      // Merge and shuffle deterministically using first 4 bytes
      const merged = [...digits, ...letters];
      const shuffled = seededShuffle(merged, bytes);
      return shuffled.join('');
    }

    // UI logic
    const elSecret = document.getElementById('secret');
    const elToggle = document.getElementById('toggle');
    const elSave = document.getElementById('save');
    const elClear = document.getElementById('clear');
    const elDate = document.getElementById('dateStr');
    const elStatus = document.getElementById('status');
    const elCode = document.getElementById('code');

    function loadSecret() {
      const s = localStorage.getItem('daily_shared_secret') || '';
      elSecret.value = s;
      return s;
    }
    function saveSecret() {
      const v = elSecret.value.trim();
      if (v) {
        localStorage.setItem('daily_shared_secret', v);
        elStatus.textContent = '口令已保存（仅本机）';
        elStatus.className = 'muted ok';
      } else {
        elStatus.textContent = '请输入非空口令';
        elStatus.className = 'muted warn';
      }
      render();
    }
    function clearSecret() {
      localStorage.removeItem('daily_shared_secret');
      elSecret.value = '';
      elStatus.textContent = '已清除口令，请输入新的共享口令';
      elStatus.className = 'muted';
      render();
    }
    elToggle.addEventListener('click', () => {
      elSecret.type = elSecret.type === 'password' ? 'text' : 'password';
      elToggle.textContent = elSecret.type === 'password' ? '显示' : '隐藏';
    });
    elSave.addEventListener('click', saveSecret);
    elClear.addEventListener('click', clearSecret);
    elSecret.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') saveSecret();
    });

    async function render() {
      const dateStr = dateInUTC8String();
      elDate.textContent = dateStr;
      const secret = (elSecret.value || '').trim();
      if (!secret) {
        elCode.textContent = '———';
        return;
      }
      try {
        const code = await deriveCode(secret, dateStr);
        elCode.textContent = code;
      } catch (e) {
        elCode.textContent = '错误';
        elStatus.textContent = '生成失败，请更换浏览器或重试';
        elStatus.className = 'muted warn';
      }
    }

    // Auto-update at midnight UTC+8 without refresh
    function scheduleMidnightTick() {
      const now = new Date();
      // compute ms to next UTC+8 midnight
      const utcNow = now.getTime() + now.getTimezoneOffset() * 60000;
      const utc8 = new Date(utcNow + 8 * 3600000);
      const next = new Date(Date.UTC(utc8.getUTCFullYear(), utc8.getUTCMonth(), utc8.getUTCDate() + 1, 0, 0, 0));
      const nextLocal = new Date(next.getTime() - 8 * 3600000 - now.getTimezoneOffset() * 60000);
      const delay = Math.max(1000, nextLocal - now);
      setTimeout(() => {
        render();
        scheduleMidnightTick();
      }, delay);
    }

    // Init
    loadSecret();
    render();
    scheduleMidnightTick();
  </script>
</body>
</html>
